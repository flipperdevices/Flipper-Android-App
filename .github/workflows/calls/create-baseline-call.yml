name: "detekt-validation"
on:
  workflow_call:
    inputs:
      BUILD_VARIANT_NAME:
        required: true
        type: string
      BUILD_VARIANT_NAME_UPPERCASE:
        required: true
        type: string
jobs:
  upload_baseline_file:
    name: Upload baseline profile file
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Git repo
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: 17

      - name: Give gradle permission
        run: chmod +x gradlew

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run baseline profiles
        uses: gradle/gradle-build-action@v2
        with:
          arguments: :instances:androidApp:generate${{ inputs.BUILD_VARIANT_NAME_UPPERCASE }}BaselineProfile -P android.testInstrumentationRunnerArguments.androidx.benchmark.enabledRules=BaselineProfile --stacktrace

      - uses: actions/upload-artifact@master
        name: "Upload baseline file"
        with:
          name: baseline_profile_file_${{ inputs.BUILD_VARIANT_NAME }}
          path: ./instances/androidApp/src/${{ inputs.BUILD_VARIANT_NAME }}/generated/baselineProfiles/baseline-prof.txt
